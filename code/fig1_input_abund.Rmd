---
title: "Relative abundance of phyla in microcosm input ingredients"
output:
  html_document:
    df_print: paged
    fig_width: 8.5
    fig_height: 11
    fig_caption: true
    toc: true
    toc_float: true
    number_sections: false
    code_folding: hide
---
```{r, messages = F, setup, cache=TRUE}
knitr::opts_knit$set(root.dir = normalizePath("."))
```
```{r, messages = F,}
library(phyloseq)
library(vegan)
library(tidyverse)
library(viridis)
library(kableExtra)
```
# Relative abundance bar plots for the incubation inputs
```{r, messages = F,}
# Read in the phyloseq object, raw object from mothur, see code file mothur_to_phyloseq.R
inc.raw.physeq <- readRDS("../data/incubation_physeq_Aug18.RDS")

# We will be characterizing the ammendments and starting soil, exclude all else
inc.inputs <- subset_samples(inc.raw.physeq, treatment %in% c("AlfalfaAmend", 
                                                              "AlfalfaSoil",
                                                              "CompostAmend"))

# Remove unclassified 
# no.unclass <- subset_taxa(inc.inputs, !Phylum=="Bacteria_unclassified")
# no.unclass <- subset_taxa(no.unclass, !Genus=="Gp6_unclassified")
# tps = no.unclass

# remove unused data
rm(inc.raw.physeq)
```
```{r, messages = F,}
tps = inc.inputs
#Let's check some of the of taxa counts from theses samples
# Minimum sample size
min(taxa_sums(otu_table(tps)))
```
```{r, messages = F,}
# Remove singletons and 0 counts
tps <- filter_taxa(tps, function(x) sum(x) >= 2, T)
min(taxa_sums(otu_table(tps)))
rm(inc.inputs)
```
```{r, messages = F,}
sample_sums(tps)
tps <- rarefy_even_depth(tps, rngseed = 423423423)
sample_sums(tps)

physeq.dist <- ordinate(tps, "PCoA", "bray")
p1 <- plot_ordination(tps, physeq.dist, type = "samples", color = "treatment")
p1
```

```{r, messages = F,}
#Stats for input.PCoA
dist <- phyloseq::distance(tps, method = "bray")
input.PCoA.stats <- adonis(dist ~ treatment, data = data.frame(sample_data(tps)))
kable(input.PCoA.stats$aov.tab)
```
```{r, messages = F,}
# Relative Abundance in inputs
# Put phyloseq object into a df with .02% phylum (glomed at phylum level)
RelativeAbundanceDf <- function(physeq) {
  physeq %>% tax_glom(taxrank = "Phylum") %>% 
    transform_sample_counts(function(x) {x/sum(x)}) %>% 
    psmelt() %>% 
    arrange(Phylum)
}


treatment_names <- c(
  "AlfalfaAmend" = "Alfalfa amendment",
  "AlfalfaSoil" = "Starting soil",
  "CompostAmend" = "Compost amendment")

# Function to plot relative abundance
PlotRelativeAbundance <- function(df) {
  ggplot(df, aes(x = as.factor(Sample), y = Abundance, fill = Phylum)) + 
  geom_bar(stat = "identity", color = "black") +
  theme(axis.title.x = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE, keywidth = 1, keyheight = 1)) + 
  ylab("Relative abundance of top 5 most abundant phyla \n in each input") +
  xlab("Incubation inputs")
}

tps.merged <- merge_samples(tps, "treatment")
sample_data(tps.merged)$treatment <- levels(sample_data(tps)$treatment)

top5 <- RelativeAbundanceDf(tps.merged) %>%
  select(Sample, Abundance, Phylum) %>%
  group_by(Sample) %>%
  arrange(desc(Abundance)) %>%
  top_n(5, Abundance)
  

plot <- PlotRelativeAbundance(top5) + 
  scale_x_discrete(labels = treatment_names) 

plot

png("../Figures/rela_abund_input.png",height=4,width=6,units='in',res=300)
plot + scale_fill_viridis(discrete = T, option = "viridis") + ggplot2::theme_bw()
dev.off()
plot + scale_fill_viridis(discrete = T, option = "viridis") + ggplot2::theme_bw()
```